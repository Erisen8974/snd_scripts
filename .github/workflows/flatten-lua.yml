name: Flatten Lua Scripts

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'If true, do not push changes (dry run)'
        required: false
        type: boolean
        default: false
  push:
    paths:
      - '*.lua'
      - 'metadata/*.meta'
      - 'metadata/*.lua'
  pull_request:
    paths:
      - '*.lua'
      - 'metadata/*.meta'
      - 'metadata/*.lua'

jobs:
  detect-files:
    runs-on: ubuntu-latest
    outputs:
      files: ${{ steps.set-matrix.outputs.files }}
    steps:
      - uses: actions/checkout@v4

      - id: set-matrix
        run: |
          files=$(find metadata -type f -name '*.meta' -exec basename {} .meta \; | jq -R . | jq -s -c .)
          echo "files=${files}" >> $GITHUB_OUTPUT

  # Parallel matrix approach: each worker produces a single artifact, then a single job
  # collects all artifacts and commits/pushes once.
  flatten-matrix:
    needs: detect-files
    runs-on: ubuntu-latest
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-files.outputs.files) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Clone target repo for sources
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.FLAT_SND_TOKEN }}@github.com/Erisen8974/flat_SND_scripts.git flat_snd_scripts

      - name: Export file
        run: |
          python exporter.py metadata/${{ matrix.file }}.lua --output ${{ matrix.file }}_flat.lua

      - name: Upload flattened file artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.file }}_flat
          path: |
            ${{ matrix.file }}_flat.lua
            ${{ matrix.file }}_flat.lua.sources

  merge-artifacts:
    needs: flatten-matrix
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone target repo for sources
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.FLAT_SND_TOKEN }}@github.com/Erisen8974/flat_SND_scripts.git flat_snd_scripts

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: flat_snd_scripts

      - name: Move flattened files into repo and commit once
        env:
          DRY_RUN: "${{ github.event.inputs.dry_run }}"
        run: |
          set -euo pipefail

          cd flat_snd_scripts
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q .; then
            git add -A
            git commit -m "Update flat scripts [auto]" || echo "No changes to commit"
            if [[ "$DRY_RUN" == "true" ]]; then
              echo "Dry run enabled - skipping git push"
            else
              git push
            fi
          else
            echo "No changes to push"
          fi